<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Landinger - AI Page Builder Chat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: #2a2a2a;
      padding: 20px;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 1.5rem;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .current-page {
      font-size: 0.9rem;
      color: #888;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-url {
      color: #667eea;
      text-decoration: none;
      hover: underline;
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      overflow: hidden;
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .message.ai .message-content {
      background: #2a2a2a;
      border: 1px solid #333;
      color: #e0e0e0;
    }

    .message.user .message-content {
      background: #667eea;
      color: white;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    .message.ai .message-avatar {
      background: #667eea;
      color: white;
    }

    .message.user .message-avatar {
      background: #3a3a3a;
      color: #888;
    }

    /* Input Area */
    .input-area {
      padding: 20px;
      background: #2a2a2a;
      border-top: 1px solid #333;
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      max-width: 900px;
      margin: 0 auto;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.3s;
    }

    .chat-input:focus {
      border-color: #667eea;
    }

    .send-btn {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    .send-btn:hover {
      background: #5a6dd8;
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Page Selector */
    .page-selector {
      padding: 15px 20px;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .page-select {
      padding: 8px 12px;
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 0.9rem;
      min-width: 200px;
    }

    .new-page-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #667eea;
      color: #667eea;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .new-page-btn:hover {
      background: #667eea;
      color: white;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #444;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Code blocks */
    .code-block {
      background: #1a1a1a;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px;
      margin: 10px 0;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      overflow-x: auto;
    }

    /* Info box */
    .info-box {
      background: #2a3f5f;
      border-left: 4px solid #667eea;
      padding: 12px;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>🚀 Landinger</h1>
    <div class="current-page" id="currentPageInfo">
      <span>No page selected</span>
    </div>
  </div>

  <!-- Page Selector -->
  <div class="page-selector">
    <select class="page-select" id="pageSelect" onchange="switchPage()">
      <option value="">Select a page...</option>
    </select>
    <button class="new-page-btn" onclick="createNewPage()">+ New Page</button>
    <div style="flex: 1;"></div>
    <div style="color: #888; font-size: 0.85rem;">
      Pages are saved at: landinger.vercel.app/[page-name].html
    </div>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <!-- Messages -->
    <div class="messages" id="messages">
      <div class="message ai">
        <div class="message-avatar">AI</div>
        <div class="message-content">
          Welcome to Landinger! 👋<br><br>
          Create a new page or select an existing one to start building. Just describe what you want and I'll create or modify the HTML for you.<br><br>
          <div class="info-box">
            💡 <strong>How it works:</strong><br>
            • First message creates the page<br>
            • Each following message updates it<br>
            • View your page at the URL shown above<br>
            • I maintain context of all previous changes
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <div class="input-wrapper">
        <input 
          type="text" 
          class="chat-input" 
          id="chatInput" 
          placeholder="Describe what you want to build or change..."
          onkeypress="handleKeyPress(event)"
        >
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let state = {
      pages: {},
      currentPage: null,
      isGenerating: false
    };

    // Load state
    function loadState() {
      const saved = localStorage.getItem('landingerChatState');
      if (saved) {
        state = { ...state, ...JSON.parse(saved) };
        renderPages();
        if (state.currentPage) {
          loadChatHistory();
          updatePageInfo();
        }
      }
    }

    // Save state
    function saveState() {
      const stateToSave = { ...state };
      delete stateToSave.isGenerating;
      localStorage.setItem('landingerChatState', JSON.stringify(stateToSave));
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadState();
      loadExistingPages();
    });

    // Load existing pages from API
    async function loadExistingPages() {
      try {
        const response = await fetch('/api/list-pages');
        if (!response.ok) return;
        
        const data = await response.json();
        if (data.pages && data.pages.length > 0) {
          data.pages.forEach(page => {
            const pageId = page.name.replace('.html', '');
            if (!state.pages[pageId]) {
              state.pages[pageId] = {
                name: page.title || pageId,
                url: page.liveUrl || page.url,
                messages: []
              };
            }
          });
          saveState();
          renderPages();
        }
      } catch (error) {
        console.log('Could not load existing pages:', error);
      }
    }

    // Render pages in dropdown
    function renderPages() {
      const select = document.getElementById('pageSelect');
      select.innerHTML = '<option value="">Select a page...</option>';
      
      Object.keys(state.pages).forEach(pageId => {
        const option = document.createElement('option');
        option.value = pageId;
        option.textContent = state.pages[pageId].name;
        if (pageId === state.currentPage) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }

    // Switch page
    function switchPage() {
      const select = document.getElementById('pageSelect');
      state.currentPage = select.value || null;
      saveState();
      loadChatHistory();
      updatePageInfo();
    }

    // Create new page
    function createNewPage() {
      const name = prompt('Enter page name (e.g., "landing", "about", "contact"):');
      if (!name) return;
      
      const pageId = name.toLowerCase().replace(/[^a-z0-9-_]/g, '_');
      
      if (state.pages[pageId]) {
        alert('Page already exists!');
        return;
      }
      
      state.pages[pageId] = {
        name: name,
        url: `https://landinger.vercel.app/${pageId}.html`,
        messages: []
      };
      
      state.currentPage = pageId;
      saveState();
      renderPages();
      loadChatHistory();
      updatePageInfo();
      
      addMessage('ai', `Created new page "${name}". Tell me what you want to build!`, false);
    }

    // Update page info
    function updatePageInfo() {
      const info = document.getElementById('currentPageInfo');
      if (state.currentPage && state.pages[state.currentPage]) {
        const page = state.pages[state.currentPage];
        info.innerHTML = `
          <span>Current page: <strong>${page.name}</strong></span>
          <span>→</span>
          <a href="${page.url}" target="_blank" class="page-url">${page.url}</a>
        `;
      } else {
        info.innerHTML = '<span>No page selected</span>';
      }
    }

    // Load chat history
    function loadChatHistory() {
      const container = document.getElementById('messages');
      container.innerHTML = '';
      
      if (!state.currentPage || !state.pages[state.currentPage]) {
        addMessage('ai', 'Select or create a page to start building!', false);
        return;
      }
      
      const messages = state.pages[state.currentPage].messages || [];
      if (messages.length === 0) {
        addMessage('ai', `Ready to build "${state.pages[state.currentPage].name}". What should this page include?`, false);
      } else {
        messages.forEach(msg => addMessage(msg.role, msg.content, false));
      }
    }

    // Add message
    function addMessage(role, content, save = true) {
      const container = document.getElementById('messages');
      const message = document.createElement('div');
      message.className = `message ${role}`;
      message.innerHTML = `
        <div class="message-avatar">${role === 'ai' ? 'AI' : 'You'}</div>
        <div class="message-content">${content}</div>
      `;
      container.appendChild(message);
      container.scrollTop = container.scrollHeight;

      if (save && state.currentPage && state.pages[state.currentPage]) {
        state.pages[state.currentPage].messages.push({ role, content });
        saveState();
      }
    }

    // Handle key press
    function handleKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        sendMessage();
      }
    }

    // Send message
    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (!message || state.isGenerating) return;
      
      if (!state.currentPage) {
        alert('Please create or select a page first');
        return;
      }

      // Add user message
      addMessage('user', message);
      input.value = '';

      // Disable input
      state.isGenerating = true;
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('sendBtn').innerHTML = '<span class="loading"></span>';

      try {
        // Call API to generate/update page
        const response = await fetch('/api/generate-page', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            instructions: message,
            pageName: state.currentPage
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API Error: ${errorText}`);
        }

        const data = await response.json();
        
        if (data.success) {
          // Update page URL if needed
          if (data.liveUrl) {
            state.pages[state.currentPage].url = data.liveUrl;
            saveState();
            updatePageInfo();
          }
          
          // Add success message
          addMessage('ai', `✅ Page updated successfully!<br><br>View it at: <a href="${data.liveUrl}" target="_blank" style="color: #667eea;">${data.liveUrl}</a><br><br>What would you like to change next?`);
        } else {
          throw new Error(data.error || 'Failed to generate page');
        }
      } catch (error) {
        console.error('Error:', error);
        if (error.message.includes('Overloaded')) {
          addMessage('ai', '⏳ The AI is currently busy. Please try again in a few seconds.');
        } else {
          addMessage('ai', `❌ Error: ${error.message}`);
        }
      } finally {
        state.isGenerating = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('sendBtn').textContent = 'Send';
      }
    }
  </script>
</body>
</html>